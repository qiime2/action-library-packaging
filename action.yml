name: 'QIIME 2 Library Packaging'
description: 'Build, test, and distribute a QIIME 2 conda package'
inputs:
  recipe-path:
    description: 'Path to recipe'
    required: false
    default: 'ci/recipe'
  package-name:
    description: 'Name of QIIME 2 package'
    required: true
  build-target:
    description: 'Target QIIME 2 release cycle: "tested" or "staged" or "released"'
    required: true
    default: 'released'
  additional-tests:
    description: 'Additional tests to run post-build'
    required: false
  library-token:
    description: 'A package token from library.qiime2.org. Required to upload built packages.'
    required: true
    default: ''
runs:
  using: 'composite'
  steps:
    # variable setup
    - run: echo "BUILD_DIR=${{ github.workspace }}/built-package" >> $GITHUB_ENV
      shell: bash
    - run: echo "RUNNER_OS=${{ runner.os }}" >> $GITHUB_ENV
      shell: bash
    - run: echo "RECIPE_PATH=${{ inputs.recipe-path }}" >> $GITHUB_ENV
      shell: bash
    - run: echo "PACKAGE_NAME=${{ inputs.package-name }}" >> $GITHUB_ENV
      shell: bash
    - run: echo "BUILD_TARGET=${{ inputs.build-target }}" >> $GITHUB_ENV
      shell: bash
    - run: echo "ADDITIONAL_TESTS=${{ inputs.additional-tests }}" >> $GITHUB_ENV
      shell: bash
    - run: echo "LIBRARY_TOKEN=${{ inputs.library-token }}" >> $GITHUB_ENV
      shell: bash

    # action steps
    - run: ${{ github.action_path }}/bin/setup.sh
      shell: bash
    - run: ${{ github.action_path }}/bin/build.sh
      shell: bash
    - run: node --unhandled-rejections=strict ${{ github.action_path }}/bin/artifact-upload/script.js
      shell: bash
    # TODO: uncomment when done developing
    # - run: ${{ github.action_path }}/bin/testing.sh
    #   shell: bash
    # TODO: uncomment when done developing
    # - run: ${{ github.action_path }}/bin/library.sh
    #   shell: bash
